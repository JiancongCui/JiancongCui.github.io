<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="JCC"><title>09-MultiMedia · Jiancong Cui</title><meta name="description" content="Notification
Application: 应用程序不在前台运行且希望向用户发出提示信息时
通知渠道: 对通知信息的细分, 可以按照通知渠道控制一类通知的重要程度(是否响铃、是否振动或者是否要关闭这个渠道的通知)

Quick Start

获取通知管理对象: NotificationMan"><meta name="keywords" content="Computer Science, Privacy Security,"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&amp;display=swap"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/tag.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="shortcut icon" href="/images/jcc.webp"><script src="/js/jquery.js"></script><!-- 主题：可换 one-dark/tomorrow/github 等 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-one-dark.css">
<!-- 行号 + 工具栏的样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/plugins/toolbar/prism-toolbar.css">
<script defer src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs/plugins/autoloader/prism-autoloader.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs/plugins/toolbar/prism-toolbar.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script><meta name="generator" content="Hexo 7.2.0"></head><body><div class="page-top animated fadeInDown"><div class="nav-container"> <div class="nav"><a class="nav-item logo" href="/">Jiancong Cui </a><a class="nav-item" href="/">About Me</a><a class="nav-item" href="/blogs">Posts</a><a class="nav-item" href="/archives">Archive</a><a class="nav-item" href="/tags">Tags</a><a class="nav-item" href="/quotes">Quotes</a></div></div></div><div id="main-container"><div class="main-content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><a>09-MultiMedia</a></div><div class="post-labels"><div class="label-item"> <i class="fa fa-clock-o"></i><span class="date">2022-08-22</span></div><div class="label-item"> <i class="fa fa-list"></i><a class="tag" href="/categories/Android-Dev/" title="Android Dev.">Android Dev.</a></div><div class="label-item"><i class="fa fa-bookmark"></i><a class="tag" href="/tags/Android/" title="Android">Android</a></div><span class="leancloud_visitors"></span></div><div class="post-content"><h1>Notification</h1>
<p>Application: 应用程序不在前台运行且希望向用户发出提示信息时</p>
<p>通知渠道: 对通知信息的细分, 可以按照通知渠道控制一类通知的重要程度(是否响铃、是否振动或者是否要关闭这个渠道的通知)</p>
<p><img src="https://raw.githubusercontent.com/Coming98/pictures/main/202208221141721.png" alt=""></p>
<h2 id="Quick-Start">Quick Start</h2>
<ol>
<li>获取通知管理对象: <code>NotificationManager</code></li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">val manager &#x3D; getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager</code></pre>
<ol start="2">
<li>创建通知渠道: <code>NotificationChannel</code></li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">if (Build.VERSION.SDK_INT &gt;&#x3D; Build.VERSION_CODES.O) &#123;
    &#x2F;&#x2F; channelId can be defined arbitrarily
    &#x2F;&#x2F; channelName is for display
    &#x2F;&#x2F; importance: NotificationManager.IMPORTANCE_HIGH, IMPORTANCE_DEFAULT, IMPORTANCE_LOW, IMPORTANCE_MIN, different notification importance means different notify action and user can change it at will
    val channel &#x3D; NotificationChannel(channelId: String, channelName: String, importance)
    manager.createNotificationChannel(channel)
&#125;</code></pre>
<ol start="3">
<li>设定通知触发的意图: 这里以触发一个 Activity 为例</li>
</ol>
<blockquote>
<p>PendingIntent can be understood as an intent to delay execution<br>
Params list is: context, 0, intent object, action (set 0 in basic use)</p>
</blockquote>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">val intent &#x3D; Intent(this, NotificationActivity::class.java)
val pendingIntent &#x3D; PendingIntent.getActivity(this, 0, intent, 0)</code></pre>
<ol start="4">
<li>创建通知对象: <code>NotificationCompat.Builder(context, channelId: String)</code></li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">val notification &#x3D; NotificationCompat.Builder(this, &quot;normal&quot;)
                .setContentTitle(&quot;This is content title&quot;)
                .setContentText(&quot;This is content text&quot;)
                .setSmallIcon(R.drawable.small_icon) &#x2F;&#x2F; 只能使用纯 alpha 图层的图片进行设置, 在系统状态栏显示
                .setLargeIcon(BitmapFactory.decodeResource(resources, R.drawable.large_icon)) &#x2F;&#x2F; 下拉状态栏后显示
                .setContentIntent(pendingIntent) &#x2F;&#x2F; PendingIntent
                .setAutoCancel(true) &#x2F;&#x2F; 表示当点击这个通知的时候，通知会自动取消
                .build()</code></pre>
<ol start="5">
<li>触发通知: <code>manager.notify(id: Int, notification)</code></li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">&#x2F;&#x2F; 需要保证每个通知指定的 id 是不同的
manager.notify(1, notification)</code></pre>
<h2 id="长文字通知">长文字通知</h2>
<p>默认情况下, 通知内容多余一行将会被 <code>...</code> 截断, 可以通过 setStyle 中的 NotificationCompat.BigTextStyle() 进行富文本化</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">.setStyle(NotificationCompat.BigTextStyle().bigText(content)) &#x2F;&#x2F; replace the .setContentText</code></pre>
<h2 id="图片通知">图片通知</h2>
<p>通过 setStyle 中的 NotificationCompat.BigPictureStyle() 进行展示</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">.setStyle(NotificationCompat.BigPictureStyle().bigPicture(BitmapFactory.decodeResource(resources, R.drawable.big_image)))</code></pre>
<h1>Take Photo</h1>
<p>调用摄像头媒体进行拍照并展示照片:</p>
<ul>
<li>定义一个 File 对象用于存储拍下的照片, 避免涉及运行时权限, 选择存储在 SD 卡的应用关联缓存目录下 <code>getExternalCacheDir()</code></li>
<li>构建目标照片的 Uri: 通过 <code>getUriForFile()</code> 进行获取</li>
</ul>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">buttonTakePhoto.setOnClickListener &#123;
    &#x2F;&#x2F; File 对象, 存放摄像头拍下的照片
    &#x2F;&#x2F; 存放在手机 SD 卡的应用关联缓存目录下 &#96;&#x2F;sdcard&#x2F;Android&#x2F;data&#x2F;&lt;package name&gt;&#x2F;cache&#96;
    outputImage &#x3D; File(externalCacheDir, &quot;output_image.jpg&quot;)
    if (outputImage.exists()) &#123;
        outputImage.delete()
    &#125;
    outputImage.createNewFile()
    imageUri &#x3D; if (Build.VERSION.SDK_INT &gt;&#x3D; Build.VERSION_CODES.N) &#123;
        &#x2F;&#x2F; 将 File 对象转换成一个封装过的 Uri 对象: context, 任意唯一字符串, file
        &#x2F;&#x2F; FileProvider 是一种特殊的 ContentProvider，它使用了和 ContentProvider 类似的机制来对数据进行保护，可以选择性地将封装过的 Uri 共享给外部，从而提高了应用的安全性
        FileProvider.getUriForFile(this, &quot;com.example.a16cameraalbumtest.fileprovider&quot;, outputImage)
    &#125; else &#123;
        Uri.fromFile(outputImage)
    &#125;
    &#x2F;&#x2F; 启动相机程序
    val intent &#x3D; Intent(&quot;android.media.action.IMAGE_CAPTURE&quot;)
    &#x2F;&#x2F; 图片输出地址
    intent.putExtra(MediaStore.EXTRA_OUTPUT, imageUri)
    &#x2F;&#x2F; 获取相机拍摄后的流文件
    ImageCaptureActivityForResult.launch(intent)
&#125;</code></pre>
<p>拍照完成后相机 Activity 将数据流返回, 通过 contentResolver 与 Uri 进行获取</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">private val ImageCaptureActivityForResult &#x3D; registerForActivityResult(ActivityResultContracts.StartActivityForResult()) &#123;
    result -&gt;
    if (result.resultCode &#x3D;&#x3D; Activity.RESULT_OK) &#123;
        val bitmap &#x3D; BitmapFactory.decodeStream(contentResolver.openInputStream(imageUri))
        &#x2F;&#x2F; 拍照时可能旋转了手机
        imageView.setImageBitmap(rotateIfRequired(bitmap))
    &#125;
&#125;

private fun rotateIfRequired(bitmap: Bitmap): Bitmap &#123;
    val exif &#x3D; ExifInterface(outputImage.path)
    val orientation &#x3D; exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL)
    return when (orientation) &#123;
        ExifInterface.ORIENTATION_ROTATE_90 -&gt; rotateBitmap(bitmap, 90)
        ExifInterface.ORIENTATION_ROTATE_180 -&gt; rotateBitmap(bitmap, 180)
        ExifInterface.ORIENTATION_ROTATE_270 -&gt; rotateBitmap(bitmap, 270)
        else -&gt; bitmap
    &#125;
&#125;
private fun rotateBitmap(bitmap: Bitmap, degree: Int): Bitmap &#123;
    val matrix &#x3D; Matrix()
    matrix.postRotate(degree.toFloat())
    val rotatedBitmap &#x3D; Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, true)
    bitmap.recycle()
    return rotatedBitmap
&#125;</code></pre>
<p>声明注册 provider: meta-data 中用于指定 uri 的共享路径通过 xml 资源进行赋值</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">&lt;provider
    android:name&#x3D;&quot;androidx.core.content.FileProvider&quot;
    android:authorities&#x3D;&quot;com.example.a16cameraalbumtest.fileprovider&quot;
    android:exported&#x3D;&quot;false&quot;
    android:grantUriPermissions&#x3D;&quot;true&quot;&gt;
    &lt;meta-data
        android:name&#x3D;&quot;android.support.FILE_PROVIDER_PATHS&quot;
        android:resource&#x3D;&quot;@xml&#x2F;file_paths&quot; &#x2F;&gt;
&lt;&#x2F;provider&gt;
&lt;!-- external-path 用于指定 Uri 的共享路径, name 属性的值可以随便填写, path 属性表示共享的具体路径 --&gt;
&lt;paths xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot;&gt;
    &lt;external-path name&#x3D;&quot;my_images&quot; path&#x3D;&quot;&#x2F;&quot; &#x2F;&gt;
&lt;&#x2F;paths&gt;</code></pre>
<h1>Select Photos</h1>
<p>从相册中选择照片, 打开系统的文件选择器 <code>Intent.ACTION_OPEN_DOCUMENT</code> 指定文件类别为 <code>Intent.CATEGORY_OPENABLE</code></p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">buttonSelectPhoto.setOnClickListener &#123;
    val intent &#x3D; Intent(Intent.ACTION_OPEN_DOCUMENT)
    intent.addCategory(Intent.CATEGORY_OPENABLE)
    &#x2F;&#x2F; 指定要显示的图片
    intent.type &#x3D; &quot;image&#x2F;*&quot;
    SelectPhotoForResult.launch(intent)
&#125;</code></pre>
<p>选定照片后通过返回的 Uri 获取资源对象</p>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">private val SelectPhotoForResult &#x3D; registerForActivityResult(ActivityResultContracts.StartActivityForResult()) &#123; result -&gt;
    if (result.resultCode &#x3D;&#x3D; Activity.RESULT_OK &amp;&amp; result.data !&#x3D; null) &#123;
        result.data?.data.let &#123; uri -&gt;
            if (uri !&#x3D; null) &#123;
                val bitmap &#x3D; getBitmapFromUri(uri)
                imageView.setImageBitmap(bitmap)
            &#125;
        &#125;
    &#125;
&#125;

private fun getBitmapFromUri(uri: Uri) &#x3D; contentResolver.openFileDescriptor(uri, &quot;r&quot;)?.use &#123;
    BitmapFactory.decodeFileDescriptor(it.fileDescriptor)
&#125;</code></pre>
<h1>Play Audio</h1>
<p>主要通过 MediaPlayer 类实现的:</p>
<ul>
<li>setDataSource(): 设置要播放的音频文件的位置</li>
<li>prepare(): 开始播放之前调用, 完成准备工作</li>
<li>start(): 开始/继续播放</li>
<li>pause()</li>
<li>reset(): 将 MediaPlayer 重置为刚刚创建的状态</li>
<li>seekTo(): 从指定位置开始播放音频</li>
<li>stop()</li>
<li>release()</li>
<li>isPlaying()</li>
<li>getDuration(): 获取载入的音频文件的时长</li>
</ul>
<ol>
<li>获取 MediaPlayer 对象 并进行初始化</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">private val mediaPalyer &#x3D; MediaPlayer()
private fun initMediaPlayer() &#123;
    val assetManager &#x3D; assets &#x2F;&#x2F; getAssets()
    &#x2F;&#x2F; 打开目标文件的句柄
    val fd &#x3D; assetManager.openFd(&quot;music.mp3&quot;)
    &#x2F;&#x2F; file descriptor
    &#x2F;&#x2F; the offset into the file where the data to be played starts, in bytes
    &#x2F;&#x2F; the length in bytes of the data to be played
    mediaPalyer.setDataSource(fd.fileDescriptor, fd.startOffset, fd.length)
    mediaPalyer.prepare()
&#125;</code></pre>
<ol start="2">
<li>按钮逻辑操作</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">when(v?.id) &#123;
    R.id.play -&gt; &#123;
        if (!mediaPalyer.isPlaying) &#123;
            mediaPalyer.start()
        &#125;
    &#125;
    R.id.pause -&gt; &#123;
        if (mediaPalyer.isPlaying) &#123;
            mediaPalyer.pause()
        &#125;
    &#125;
    R.id.stop -&gt; &#123;
        mediaPalyer.reset()
        initMediaPlayer()
    &#125;
&#125;</code></pre>
<ol start="3">
<li>Activity 被销毁时记得释放 MediaPlayer</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">override fun onDestroy() &#123;
    super.onDestroy()
    mediaPalyer.stop()
    mediaPalyer.release()
&#125;</code></pre>
<h1>Play Video</h1>
<p>主要通过 VideoView 类实现的, 通过命名可以看出, 这个类将 Video 的显示与控制集一身:</p>
<ul>
<li>setVideoPath(): 设置要播放的视频文件</li>
<li>resume(): 将视频从头开始播放</li>
<li>suspend(): 释放 VideoView</li>
<li>start, pause, seekTo, isPlaying, getDuration</li>
</ul>
<p>Tips: VideoView 不支持直接播放 assets 目录下的视频资源, 但是支持播放 <code>res/raw/*</code> 目录下的视频资源</p>
<ol>
<li>设置媒体对象</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">videoView &#x3D; findViewById(R.id.videoView)

val uri &#x3D; Uri.parse(&quot;android.resource:&#x2F;&#x2F;$packageName&#x2F;$&#123;R.raw.video&#125;&quot;)
videoView.setVideoURI(uri)
videoView.setMediaController(MediaController(this))</code></pre>
<ol start="2">
<li>逻辑控制</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">when(v?.id) &#123;
    R.id.play -&gt; &#123;
        if (!videoView.isPlaying) &#123;
            videoView.start()
        &#125;
    &#125;
    R.id.pause -&gt; &#123;
        if (videoView.isPlaying) &#123;
            videoView.pause()
        &#125;
    &#125;
    R.id.replay -&gt; &#123;
        if (videoView.isPlaying) &#123;
            videoView.resume()
        &#125;
    &#125;
&#125;</code></pre>
<ol start="3">
<li>事后释放</li>
</ol>
<pre class="language-kotlin" data-language="kotlin"><code class="language-kotlin">override fun onDestroy() &#123;
    super.onDestroy()
    videoView.suspend()
&#125;</code></pre>
</div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://jiancongcui.github.io/2022/08/22/09-MultiMedia/,Jiancong Cui,09-MultiMedia,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/08/23/10-Service/" title="10-Service">prev_post</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/08/21/08-Content-Provider/" title="08-Content Provider">next_post</a></li></ul></div></div></div><div class="footer animated fadeInDown"><div class="p"> <span>© 2024 - 2029 </span><i class="fa fa-star"></i><span> JCC</span></div><div class="by_farbox"><span>Powered by </span><a href="https://sites.google.com/new" target="_blank">Google Sites </a><span> & </span><a href="https://github.com/Ben02/hexo-theme-Anatole" target="_blank">Ben </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core </a></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>